{% extends 'core/base.html' %}
{% load currency_filters %}

{% block title %}Create Account & Enroll - {{ course.title }} - LUM Data Academy{% endblock %}

{% block content %}
<div class="min-h-screen pt-20">
    <!-- Guest Enrollment Header -->
    <section class="bg-gradient-to-br from-primary to-primary-dark text-white py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold mb-4">ðŸš€ Create Account & Enroll</h1>
                <h2 class="text-xl md:text-2xl font-semibold text-white/90">{{ course.title }}</h2>
                <p class="text-white/80 mt-2">Join thousands of students advancing their careers with LUM Data Academy</p>
            </div>
        </div>
    </section>

    <!-- Registration & Enrollment Form -->
    <section class="py-16">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid lg:grid-cols-3 gap-12">
                <!-- Registration Form -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">Create Your Account</h3>
                            <p class="text-gray-600">Get started with your personalized learning journey in just a few steps.</p>
                        </div>

                        <form method="post" class="space-y-6">
                            {% csrf_token %}
                            
                            <!-- Display form errors -->
                            {% if form.errors %}
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                                <ul class="list-disc pl-5 space-y-1">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                        <li>{{ field|title }}: {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            <!-- Personal Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                    <div class="mt-1 text-sm text-red-600">{{ form.first_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div>
                                    <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                    <div class="mt-1 text-sm text-red-600">{{ form.last_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Account Information -->
                            <div>
                                <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                <div class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</div>
                                {% endif %}
                                <div class="mt-1 text-sm text-gray-500">
                                    We'll send your course materials and updates to this email
                                </div>
                            </div>

                            <div>
                                <label for="{{ form.username.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                                {{ form.username }}
                                {% if form.username.errors %}
                                <div class="mt-1 text-sm text-red-600">{{ form.username.errors.0 }}</div>
                                {% endif %}
                                <div class="mt-1 text-sm text-gray-500">
                                    This will be your login username
                                </div>
                            </div>

                            <!-- Location Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ form.country.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                                    {{ form.country }}
                                    {% if form.country.errors %}
                                    <div class="mt-1 text-sm text-red-600">{{ form.country.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div>
                                    <label for="{{ form.state_city.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">State/City *</label>
                                    {{ form.state_city }}
                                    {% if form.state_city.errors %}
                                    <div class="mt-1 text-sm text-red-600">{{ form.state_city.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Password Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ form.password1.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                                    {{ form.password1 }}
                                    {% if form.password1.errors %}
                                    <div class="mt-1 text-sm text-red-600">{{ form.password1.errors.0 }}</div>
                                    {% endif %}
                                    <div class="mt-1 text-sm text-gray-500">
                                        Minimum 8 characters with letters and numbers
                                    </div>
                                </div>
                                <div>
                                    <label for="{{ form.password2.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password *</label>
                                    {{ form.password2 }}
                                    {% if form.password2.errors %}
                                    <div class="mt-1 text-sm text-red-600">{{ form.password2.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Learning Goals (Optional) -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">ðŸŽ¯ What are your learning goals? (Optional)</h4>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2">
                                        <span class="text-sm text-gray-700">Career advancement in data science</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2">
                                        <span class="text-sm text-gray-700">Skill development for current role</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2">
                                        <span class="text-sm text-gray-700">Personal interest and growth</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2">
                                        <span class="text-sm text-gray-700">Career transition to tech</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Terms and Marketing -->
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="checkbox" required class="mt-1 mr-3">
                                    <div class="text-sm text-gray-600">
                                        I agree to LUM Data Academy's <a href="#" class="text-primary font-medium hover:text-primary-dark">Terms of Service</a> and 
                                        <a href="#" class="text-primary font-medium hover:text-primary-dark">Privacy Policy</a>. *
                                    </div>
                                </label>
                                
                                <label class="flex items-start">
                                    <input type="checkbox" class="mt-1 mr-3">
                                    <div class="text-sm text-gray-600">
                                        I'd like to receive updates about new courses, special offers, and career tips via email. 
                                        (You can unsubscribe anytime)
                                    </div>
                                </label>
                            </div>

                            <!-- Submit Button -->
                            <div class="pt-4">
                                <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-4 px-6 rounded-lg transition-colors">
                                    ðŸŽ“ Create Account & Continue to Enrollment
                                </button>
                            </div>
                        </form>

                        <!-- Login Link -->
                        <div class="mt-6 pt-6 border-t text-center">
                            <p class="text-gray-600">
                                Already have an account? 
                                <a href="{% url 'accounts:login' %}?next={% url 'core:enroll_course' slug=course.slug %}" 
                                   class="text-primary font-medium hover:text-primary-dark">
                                    Sign in to enroll
                                </a>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Course Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg p-6 sticky top-20">
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">You're Enrolling In</h4>
                            {% if course.image %}
                            <img src="{{ course.image.url }}" alt="{{ course.title }}" class="w-full aspect-video object-cover rounded-lg mb-4">
                            {% endif %}
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div>
                                <div class="text-sm text-gray-600">Course</div>
                                <div class="font-semibold text-gray-900">{{ course.title }}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Category</div>
                                <div class="font-semibold text-gray-900">{{ course.category.display_name }}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Duration</div>
                                <div class="font-semibold text-gray-900">{{ course.duration }}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Modules</div>
                                <div class="font-semibold text-gray-900">{{ course.total_modules }}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Est. Hours</div>
                                <div class="font-semibold text-gray-900">{{ course.estimated_hours }} hours</div>
                            </div>
                        </div>
                        
                        <!-- Pricing -->
                        <div class="border-t pt-4 mb-6">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-900">Course Price</span>
                                <span class="text-2xl font-bold text-primary">
                                    KShs {{ course.price_kes|floatformat:0 }}
                                </span>
                            </div>
                            {% if course.discount_price %}
                            <div class="text-sm text-gray-500 text-right">
                                <span class="line-through">KShs {{ course.original_price_kes|floatformat:0 }}</span>
                                <span class="text-green-600 font-medium ml-1">Save KShs {{ course.savings_kes|floatformat:0 }}</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- What's Included -->
                        <div class="border-t pt-4">
                            <h5 class="font-semibold text-gray-900 mb-3">What's Included</h5>
                            <div class="space-y-2 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    Lifetime access to materials
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    Certificate of completion
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    Hands-on projects & exercises
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    Career support & mentorship
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    Job placement assistance
                                </div>
                            </div>
                        </div>

                        <!-- Payment Methods -->
                        <div class="mt-6 pt-4 border-t">
                            <h5 class="font-semibold text-gray-900 mb-3">Payment Options</h5>
                            <div class="flex space-x-2">
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">M-Pesa</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">PayPal</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium">Installments</span>
                            </div>
                        </div>

                        <!-- Trust Signals -->
                        <div class="mt-6 pt-4 border-t text-center">
                            <div class="text-sm text-gray-600 space-y-1">
                                <div>âœ… 5000+ Happy Students</div>
                                <div>âœ… Industry-Expert Instructors</div>
                                <div>âœ… Career-Focused Curriculum</div>
                                <div>âœ… Lifetime Support</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
// Enhanced form validation for unified registration form
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (!form) return;
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        const password1 = document.getElementById('{{ form.password1.id_for_label }}');
        const password2 = document.getElementById('{{ form.password2.id_for_label }}');
        
        if (password1 && password1.value.length < 8) {
            e.preventDefault();
            alert('Password must be at least 8 characters long.');
            password1.focus();
            return;
        }
        
        // Check if password contains letters and numbers
        if (password1) {
            const hasLetter = /[a-zA-Z]/.test(password1.value);
            const hasNumber = /\d/.test(password1.value);
            
            if (!hasLetter || !hasNumber) {
                e.preventDefault();
                alert('Password must contain both letters and numbers.');
                password1.focus();
                return;
            }
        }
        
        // Check password confirmation matches
        if (password1 && password2 && password1.value !== password2.value) {
            e.preventDefault();
            alert('Password confirmation must match the password.');
            password2.focus();
            return;
        }
    });
    
    // Username validation (no spaces, special characters)
    const usernameField = document.getElementById('{{ form.username.id_for_label }}');
    if (usernameField) {
        usernameField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^a-zA-Z0-9_]/g, '');
            e.target.value = value;
        });
    }
});
</script>
{% endblock %}